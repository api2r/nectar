test_that("req_auth_api_key errors informatively with unused arguments", {
  expect_error(
    {
      req_auth_api_key(
        httr2::request("https://example.com"),
        location = "header",
        api_key = "ok",
        file_path = "bad"
      )
    },
    class = "rlib_error_dots_nonempty"
  )
})

test_that("req_auth_api_key returns req unchanged if no api_key set", {
  req <- httr2::request("https://example.com")
  test_result <- req_auth_api_key(req, "parm")
  expect_identical(req, test_result)
})

test_that("req_auth_api_key works for header", {
  test_result <- req_auth_api_key(
    httr2::request("https://example.com"),
    parameter_name = "parm",
    api_key = "my_key"
  )
  expect_in(
    names(test_result$headers),
    "parm"
  )
  expect_type(
    test_result$headers$parm,
    "weakref"
  )

  test_result <- req_auth_api_key(
    httr2::request("https://example.com"),
    parameter_name = "parm",
    api_key = "my_key",
    location = "header"
  )
  expect_in(
    names(test_result$headers),
    "parm"
  )
  expect_type(
    test_result$headers$parm,
    "weakref"
  )
})

test_that("req_auth_api_key works for query", {
  test_result <- req_auth_api_key(
    httr2::request("https://example.com"),
    parameter_name = "parm",
    api_key = "my_key",
    location = "query"
  )
  # In httr2 <=1.0.7, path can be NULL. in 1.1.0+, path is normalized to at
  # least "/". Normalize to make sure this test passes in both of those
  # versions.
  test_result$url <- stringr::str_replace(
    test_result$url,
    stringr::fixed("example.com?parm"),
    stringr::fixed("example.com/?parm")
  )
  expect_identical(
    test_result$url,
    "https://example.com/?parm=my_key"
  )
})

test_that("req_auth_api_key works for cookies", {
  test_result <- req_auth_api_key(
    httr2::request("https://example.com"),
    parameter_name = "parm",
    api_key = "my_key",
    location = "cookie"
  )
  expect_in(
    test_result$options,
    list(cookie = "parm=my_key")
  )
})
